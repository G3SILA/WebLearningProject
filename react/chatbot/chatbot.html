<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="chatbot.css">
</head>
<body>
    <div class="js-container"></div>
    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>
    <script src="https://unpkg.com/supersimpledev/babel.js"></script>

    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src="https://unpkg.com/supersimpledev/dayjs.js"></script>

    <script type="text/babel">

        function useAutoScroll(dependencies) {
            const ref = React.useRef(null);
            // hook in React, runs a function after the component is created/updated
            React.useEffect(() => {
                const containerElem = ref.current;
                if (containerElem) {
                    containerElem.scrollTop = containerElem.scrollHeight; 
                }
            }, dependencies);
            return ref;
        }

        // component name must start with Capital letter
        function ChatInput({chatMessages, setChatMessages}) {
            const [inputText, setInputText] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false); 

            function saveInputText(event) {
                setInputText(event.target.value); 
            }
            
            async function sendMessage() {
                if (isLoading || inputText === '') return; 
                setIsLoading(true); 
                // matches with value={inputText}, to clear the input box after sent
                setInputText('');

                // copy the array into this new array
                // ...is the spread operator
                const newChatMessages = [
                    ...chatMessages, 
                    {
                        message: inputText,
                        sender: 'user',
                        id: crypto.randomUUID()
                    }
                ];
                // store in a variable because ChatMessages is not updated
                //   immediately, but after the function is done. 
                // setChatMessages(newChatMessages); 
                
                setChatMessages([
                    ...newChatMessages, 
                    {
                        message: <img src="loading-spinner.gif" className="loading-img" />,
                        sender: 'robot',
                        id: crypto.randomUUID()
                    }
                ]); 

                const response = await Chatbot.getResponseAsync(inputText);
                setChatMessages([
                    ...newChatMessages, 
                    {
                        message: response,
                        sender: 'robot',
                        id: crypto.randomUUID()
                    }
                ]); 
                setIsLoading(false); 
            }

            // JSX requires closing tag on input
            // <input /> is a shortcut for <input></input>

            // can only return one element at a time
            // fragment: only brackets <>, similar to <div> but doesn't add extra div element 
            return (
                <div className="chat-input-container">
                    <input 
                        placeholder="Send a message to Chatbot" 
                        size="30" 
                        onChange={saveInputText}
                        value={inputText}
                        onKeyDown={(event) => {
                            if (event.key === 'Enter') sendMessage();
                            else if (event.key === 'Escape')  setInputText('');
                        }}
                        className="chat-input"
                    />  
                    <button 
                        onClick= {sendMessage}
                        className="send-button"
                    >Send</button> 
                    </div>
            ); // size: # of characters fit 
            // Notice React use className instead of class!
        }
        
        // props is an object containing all the attributes
        // can also destructuring in parameters: 
        // e.g.  function ChatMessage({message, sender}) {}
        function ChatMessage(props) {
            // const message = props.message; 
            // const sender = props.sender;

            const {message, sender} = props; 
            /*
                if (sender === 'robot') {
                    return (
                        <div>
                            <img src="robot.png" width="50" />
                            {message}
                        </div>
                    );
                }
            */

            // move "if" inside
            return (
                <div className={sender === 'robot'? 'chat-message-robot' : 'chat-message-user'}>
                    {sender === 'robot' && <img src="robot.png"/>}
                    <div className="chat-message-text"> {message} </div>
                    {sender === 'user' && <img src="user.png"/>}
                </div>
            );
        }

        function ChatMessages({chatMessages}) {
            /*
            // hook, save an HTML element from component
            const chatMessagesRef = React.useRef(null);
            // hook in React, runs a function after the component is created/updated
            React.useEffect(() => {
                const containerElem = chatMessagesRef.current;
                if (containerElem) {
                    containerElem.scrollTop = containerElem.scrollHeight; 
                }
            }, [chatMessages]); // second paramter stores data that needs to be tracked
            // Dependency Array: control when useEffect runs
            */

            const chatMessagesRef = useAutoScroll([chatMessages]); 
            
            return (
                <div className="chat-messages-container" ref={chatMessagesRef}>
                    {chatMessages.map((chatMessage) => {
                        return (
                            <ChatMessage 
                                message={chatMessage.message}
                                sender={chatMessage.sender} 
                                key={chatMessage.id}
                            />
                        );
                    })}
                </div>
            );
        }


        // component syxtax: create our own HTML element
        // also works: {ChatInput()}
        //             <ChatInput></ChatInput>
        function App() {

            // state bounds HTML and data, auto-updates HTML
            const [chatMessages, setChatMessages]= React.useState([]); 

            
            /*
                // current data, first element 
                const chatMessages = array[0];
                // function to update html, second element
                const setChatMessages = array[1]; // updater function
            */

            return (
                <div className="app-container">
                    {chatMessages.length === 0 && 
                        <p className='welcome-message'>
                            Welcome to the chatbot project! Send a message using the textbox below
                        </p>}
                    <ChatMessages 
                        chatMessages={chatMessages}
                    />
                    <ChatInput 
                        chatMessages={chatMessages}
                        setChatMessages={setChatMessages}
                    /> 
                </div>
            );
        }
        

        const container = document.querySelector('.js-container');
        ReactDOM.createRoot(container).render(<App />); 
    </script>
</body>
</html>
